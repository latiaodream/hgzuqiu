# 宝塔定时任务设置指南

## 📋 需要设置的定时任务

系统有 **2个定时任务** 需要在宝塔面板中设置：

### 1️⃣ 同步皇冠历史数据（每天凌晨2点）
### 2️⃣ 下注结算任务（已自动运行，无需手动设置）

---

## 🚀 任务1：同步皇冠历史数据

### 功能说明
- **作用**：每天凌晨2点自动同步所有在线账号的**昨天**历史数据到数据库
- **为什么只同步昨天的数据？**
  - 当天的数据会不断变化（用户持续投注）
  - 只同步昨天及之前的历史数据，确保数据稳定准确
  - 前端"查账"功能默认只显示昨天及之前的数据

### 设置步骤

#### 第1步：修改管理员密码

编辑文件：`/www/wwwroot/aibcbot.top/scripts/sync-history-aibcbot.sh`

找到第38行，修改管理员密码：

```bash
ADMIN_PASSWORD="admin123"  # ⚠️ 请修改为实际密码
```

#### 第2步：添加宝塔定时任务

1. 登录宝塔面板
2. 点击左侧菜单 **"计划任务"**
3. 点击 **"添加计划任务"**
4. 填写以下信息：

| 字段 | 值 |
|------|-----|
| 任务类型 | Shell脚本 |
| 任务名称 | 同步皇冠历史数据 |
| 执行周期 | 每天 02:00 |
| 脚本内容 | `/bin/bash /www/wwwroot/aibcbot.top/scripts/sync-history-aibcbot.sh` |

5. 点击 **"提交"**

#### 第3步：测试运行

在宝塔面板的计划任务列表中，找到刚才添加的任务，点击 **"执行"** 按钮进行测试。

### 查看日志

```bash
# 查看今天的日志
tail -f /www/wwwroot/aibcbot.top/logs/sync-history-$(date +%Y%m%d).log

# 查看最近50行
tail -n 50 /www/wwwroot/aibcbot.top/logs/sync-history-$(date +%Y%m%d).log
```

### 日志示例

```
[2025-10-26 02:00:01] =========================================
[2025-10-26 02:00:01] 开始同步昨天的历史数据
[2025-10-26 02:00:01] =========================================
[2025-10-26 02:00:01] 同步日期: 2025-10-25
[2025-10-26 02:00:01] 正在登录获取token...
[2025-10-26 02:00:02] ✅ 登录成功
[2025-10-26 02:00:02] 正在查询在线账号...
[2025-10-26 02:00:02] 找到 12 个在线账号
[2025-10-26 02:00:02] -----------------------------------------
[2025-10-26 02:00:02] 处理账号: elrukeblnl8 (ID: 23)
[2025-10-26 02:00:02]   📡 正在调用API获取数据...
[2025-10-26 02:00:10]   ✅ 同步成功
[2025-10-26 02:00:12] 处理账号: 0TnQHLra61 (ID: 22)
[2025-10-26 02:00:12]   ⏭️  跳过: 数据已存在
...
[2025-10-26 02:05:30] -----------------------------------------
[2025-10-26 02:05:30] 同步完成！
[2025-10-26 02:05:30] 总账号数: 12
[2025-10-26 02:05:30] 成功: 10
[2025-10-26 02:05:30] 跳过: 2
[2025-10-26 02:05:30] 失败: 0
[2025-10-26 02:05:30] =========================================
```

---

## 🎯 任务2：下注结算任务

### 功能说明
- **作用**：自动同步下注记录的输赢和比分
- **执行频率**：每24小时执行一次
- **状态**：✅ 已自动运行，无需手动设置

### 工作原理

1. **补齐官网单号**：为 pending 且无 official_bet_id 的注单尝试从皇冠API获取单号
2. **同步结算结果**：为 confirmed 或 pending 且有 official_bet_id 的注单同步输赢结果

### 查看运行状态

```bash
# 查看后端日志
pm2 logs bclogin-backend --lines 50

# 查看结算任务日志（搜索 "结算任务"）
pm2 logs bclogin-backend | grep "结算任务"
```

### 日志示例

```
🔄 [2025-10-26 15:00:00] 开始执行下注结算任务...
ℹ️  没有需要补齐单号的注单
✅ 补齐单号完成: 0/0 条
ℹ️  没有需要同步结算的注单
✅ 结算任务完成: 总计 0 条，更新 0 条，失败 0 条，跳过 0 条
```

---

## 🛠️ 故障排查

### 问题1：脚本执行失败

**检查脚本权限：**
```bash
ls -la /www/wwwroot/aibcbot.top/scripts/sync-history-aibcbot.sh
# 应该显示 -rwxr-xr-x (可执行权限)

# 如果没有执行权限，添加：
chmod +x /www/wwwroot/aibcbot.top/scripts/sync-history-aibcbot.sh
```

### 问题2：登录失败

**检查管理员密码：**
- 确认脚本中的 `ADMIN_PASSWORD` 是否正确
- 尝试手动登录测试：
```bash
curl -X POST "http://localhost:3001/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"你的密码"}'
```

### 问题3：数据库连接失败

**检查数据库配置：**
```bash
PGPASSWORD=AbDN22pKhcsNnJSk psql -h 127.0.0.1 -p 5432 -U hgzuqiu -d hgzuqiu -c "SELECT COUNT(*) FROM crown_accounts;"
```

### 问题4：后端服务未运行

**检查后端状态：**
```bash
pm2 status
pm2 logs bclogin-backend --lines 20
```

**重启后端：**
```bash
pm2 restart bclogin-backend
```

---

## 📊 监控建议

### 1. 定期检查日志

每周检查一次同步日志，确保任务正常执行：

```bash
# 查看最近7天的日志文件
ls -lh /www/wwwroot/aibcbot.top/logs/sync-history-*.log

# 查看昨天的日志
cat /www/wwwroot/aibcbot.top/logs/sync-history-$(date -d "yesterday" +%Y%m%d).log
```

### 2. 设置告警

如果需要，可以在宝塔面板中设置邮件或微信告警，当任务执行失败时自动通知。

### 3. 数据验证

定期检查数据库中的历史数据是否完整：

```bash
# 检查最近7天的数据
PGPASSWORD=AbDN22pKhcsNnJSk psql -h 127.0.0.1 -p 5432 -U hgzuqiu -d hgzuqiu -c "
SELECT date, COUNT(*) as record_count 
FROM account_history 
WHERE date >= CURRENT_DATE - INTERVAL '7 days' 
GROUP BY date 
ORDER BY date DESC;
"
```

---

## ✅ 设置完成检查清单

- [ ] 修改了脚本中的管理员密码
- [ ] 在宝塔面板中添加了定时任务
- [ ] 测试运行了定时任务
- [ ] 查看了日志，确认任务执行成功
- [ ] 确认后端服务正常运行
- [ ] 确认下注结算任务自动运行

---

## 📞 技术支持

如果遇到问题，请提供以下信息：

1. 错误日志（从 `/www/wwwroot/aibcbot.top/logs/` 目录）
2. 后端日志（`pm2 logs bclogin-backend`）
3. 数据库连接测试结果
4. 宝塔面板中的任务执行记录

---

**最后更新时间：** 2025-10-26

