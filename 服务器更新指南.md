# 服务器更新指南 - 限额自动获取功能

## 🎯 更新内容

本次更新添加了**账号限额自动获取功能**：
- ✅ 新增账号时自动从皇冠网站获取限额
- ✅ 编辑账号时可以手动获取限额
- ✅ 自动保存到数据库
- ✅ 友好的用户提示

## 🖥️ 服务器信息

- **服务器IP**: 47.238.112.207
- **用户名**: root
- **密码**: latiao@2025
- **项目目录**: /www/wwwroot/aibcbot.top
- **访问地址**: https://aibcbot.top

## 🚀 更新步骤

### 方法 1: 一键更新（推荐）⭐

#### 步骤 1: 连接服务器

```bash
ssh root@47.238.112.207
# 输入密码: latiao@2025
```

#### 步骤 2: 进入项目目录

```bash
cd /www/wwwroot/aibcbot.top
```

#### 步骤 3: 运行更新脚本

```bash
bash server-update.sh
```

**就这么简单！** 脚本会自动完成：
1. ✅ 备份当前代码
2. ✅ 拉取最新代码
3. ✅ 安装后端依赖
4. ✅ 编译后端代码
5. ✅ 重启后端服务
6. ✅ 更新前端代码
7. ✅ 重启 Nginx
8. ✅ 运行功能测试
9. ✅ 显示服务状态

### 方法 2: 手动更新

如果你想手动控制每一步：

#### 1. 连接服务器

```bash
ssh root@47.238.112.207
```

#### 2. 进入项目目录

```bash
cd /www/wwwroot/aibcbot.top
```

#### 3. 备份当前代码（可选但推荐）

```bash
tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz backend frontend
```

#### 4. 拉取最新代码

```bash
git pull origin main
```

**预期输出**：
```
remote: Enumerating objects: 39, done.
remote: Counting objects: 100% (39/39), done.
Updating b199e02..2969eac
Fast-forward
 backend/src/routes/crown-automation.ts           | 65 ++++++++++
 backend/src/services/crown-automation.ts         | 162 +++++++++++++++++++++++
 ...
 12 files changed, 2138 insertions(+)
```

#### 5. 更新后端

```bash
cd backend
npm install
npm run build
```

#### 6. 重启后端服务

```bash
/www/server/nodejs/v22.18.0/bin/pm2 restart bclogin-backend
```

#### 7. 更新前端

```bash
cd ../frontend
npm install
npm run build
```

#### 8. 重启 Nginx

```bash
nginx -s reload
```

#### 9. 查看服务状态

```bash
/www/server/nodejs/v22.18.0/bin/pm2 status
```

#### 10. 查看日志

```bash
/www/server/nodejs/v22.18.0/bin/pm2 logs bclogin-backend --lines 20
```

### 方法 3: 快速命令（一行搞定）

```bash
cd /www/wwwroot/aibcbot.top && \
git pull origin main && \
cd backend && npm install && npm run build && \
/www/server/nodejs/v22.18.0/bin/pm2 restart bclogin-backend && \
cd ../frontend && npm install && npm run build && \
nginx -s reload && \
/www/server/nodejs/v22.18.0/bin/pm2 logs bclogin-backend --lines 20 --nostream
```

## ✅ 验证更新

### 1. 检查代码版本

```bash
cd /www/wwwroot/aibcbot.top
git log --oneline -1
```

应该显示：
```
2969eac docs: 添加部署和更新指南
```

### 2. 检查服务状态

```bash
/www/server/nodejs/v22.18.0/bin/pm2 status
```

应该显示 `bclogin-backend` 状态为 `online`

### 3. 测试后端功能

```bash
cd /www/wwwroot/aibcbot.top/backend
node backend/test-fetch-limits.js
```

应该显示：
```
🧪 开始测试限额获取功能...
✅ 登录成功
✅ 限额页面获取成功
✅ 找到足球限额表格
✅ 找到篮球限额表格
✅ 测试完成！限额获取功能正常工作
```

### 4. 测试前端功能

1. 打开浏览器访问 https://aibcbot.top
2. 使用测试账号登录：
   - 用户名: zhuren
   - 密码: 123456
3. 进入"账号管理"页面
4. 点击"添加账号"
5. 填写账号信息并保存
6. 观察是否显示"正在自动获取限额信息..."
7. 验证是否显示"限额信息已自动获取并保存"

## 🔍 查看日志

### 实时查看后端日志

```bash
/www/server/nodejs/v22.18.0/bin/pm2 logs bclogin-backend --follow
```

按 `Ctrl+C` 退出

### 查看最近 50 行日志

```bash
/www/server/nodejs/v22.18.0/bin/pm2 logs bclogin-backend --lines 50 --nostream
```

### 只查看错误日志

```bash
/www/server/nodejs/v22.18.0/bin/pm2 logs bclogin-backend --err --lines 50
```

### 查看 Nginx 日志

```bash
# 访问日志
tail -f /var/log/nginx/access.log

# 错误日志
tail -f /var/log/nginx/error.log
```

## 🐛 故障排除

### 问题 1: git pull 失败

**错误信息**：
```
error: Your local changes to the following files would be overwritten by merge
```

**解决方案**：
```bash
# 保存本地修改
git stash

# 拉取最新代码
git pull origin main

# 恢复本地修改（如果需要）
git stash pop
```

### 问题 2: npm install 失败

**错误信息**：
```
npm ERR! code ECONNREFUSED
```

**解决方案**：
```bash
# 清除缓存
npm cache clean --force

# 删除 node_modules
rm -rf node_modules package-lock.json

# 重新安装
npm install
```

### 问题 3: 编译失败

**错误信息**：
```
error TS2307: Cannot find module
```

**解决方案**：
```bash
# 删除编译输出
rm -rf dist

# 重新安装依赖
rm -rf node_modules package-lock.json
npm install

# 重新编译
npm run build
```

### 问题 4: PM2 重启失败

**错误信息**：
```
[PM2] Process not found
```

**解决方案**：
```bash
# 查看所有进程
/www/server/nodejs/v22.18.0/bin/pm2 list

# 如果没有进程，重新启动
cd /www/wwwroot/aibcbot.top/backend
/www/server/nodejs/v22.18.0/bin/pm2 start npm --name "bclogin-backend" -- run start
```

### 问题 5: Nginx 重启失败

**错误信息**：
```
nginx: [error] invalid PID number
```

**解决方案**：
```bash
# 测试配置
nginx -t

# 如果配置正确，强制重启
systemctl restart nginx
```

### 问题 6: 限额获取失败

**可能原因**：
1. 账号密码错误
2. 皇冠网站无法访问
3. 网络连接问题

**解决方案**：
```bash
# 1. 测试网络连接
curl https://hga038.com

# 2. 运行测试脚本
cd /www/wwwroot/aibcbot.top/backend
node backend/test-fetch-limits.js

# 3. 查看后端日志
/www/server/nodejs/v22.18.0/bin/pm2 logs bclogin-backend --lines 50
```

## 🔄 回滚步骤

如果更新后出现问题，可以回滚：

### 方法 1: 使用备份文件

```bash
cd /www/wwwroot/aibcbot.top

# 查看备份文件
ls -lh backup-*.tar.gz

# 解压备份（替换为实际的备份文件名）
tar -xzf backup-20251028-143000.tar.gz

# 重新编译
cd backend
npm run build

# 重启服务
/www/server/nodejs/v22.18.0/bin/pm2 restart bclogin-backend
```

### 方法 2: 使用 Git 回滚

```bash
cd /www/wwwroot/aibcbot.top

# 查看提交历史
git log --oneline -10

# 回滚到上一个版本
git reset --hard b199e02

# 重新编译
cd backend
npm run build

# 重启服务
/www/server/nodejs/v22.18.0/bin/pm2 restart bclogin-backend
```

## 📊 监控和维护

### 查看服务器资源

```bash
# 查看磁盘空间
df -h

# 查看内存使用
free -h

# 查看 CPU 使用
top

# 查看进程
ps aux | grep node
```

### 定期维护

```bash
# 清理旧的备份文件（保留最近 5 个）
cd /www/wwwroot/aibcbot.top
ls -t backup-*.tar.gz | tail -n +6 | xargs rm -f

# 清理 PM2 日志
/www/server/nodejs/v22.18.0/bin/pm2 flush

# 清理 npm 缓存
npm cache clean --force
```

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `SERVER_CONFIG.md` | 服务器配置信息 |
| `QUICK_REFERENCE_LIMITS.md` | 快速参考指南 |
| `DEPLOYMENT_GUIDE.md` | 详细部署指南 |
| `TEST_FETCH_LIMITS.md` | 测试指南 |

## 🎉 更新完成

更新完成后，你的系统将拥有：

✅ **自动化**: 新增账号时自动获取限额  
✅ **便捷性**: 编辑账号时一键更新限额  
✅ **准确性**: 直接从皇冠网站获取最新数据  
✅ **友好性**: 清晰的提示和错误处理  

现在可以访问 https://aibcbot.top 使用新功能了！

---

**更新日期**: 2025-10-28  
**版本**: v1.0.0  
**服务器**: 47.238.112.207  
**项目目录**: /www/wwwroot/aibcbot.top

