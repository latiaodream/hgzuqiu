# 测试限额获取功能

## 快速测试

### 方法 1: 使用测试脚本（后端测试）

1. 确保后端代码已编译：
```bash
cd backend
npm run build
```

2. 运行测试脚本：
```bash
node backend/test-fetch-limits.js
```

3. 查看输出，应该显示：
```
🧪 开始测试限额获取功能...

📝 测试账号: heizi2025
============================================================

1️⃣ 测试登录...
✅ 登录成功

2️⃣ 获取限额页面...
   URL: https://hga038.com/app/member/account/account_wager_limit.php
✅ 限额页面获取成功

3️⃣ 解析限额数据...
✅ 找到足球限额表格
✅ 找到篮球限额表格

4️⃣ 解析结果:
============================================================

⚽ 足球限额:
   赛前限额: 200,000
   滚球限额: 200,000

🏀 篮球限额:
   赛前限额: 200,000
   滚球限额: 200,000

============================================================
✅ 测试完成！限额获取功能正常工作
```

### 方法 2: 通过前端界面测试（完整流程）

#### 测试自动获取（新增账号）

1. 启动前后端服务：
```bash
# 终端 1: 启动后端
cd backend
npm run dev

# 终端 2: 启动前端
cd frontend
npm run dev
```

2. 打开浏览器访问 `http://localhost:10087`

3. 登录系统

4. 进入"账号管理"页面

5. 点击"添加账号"按钮

6. 填写账号信息：
   - 选择分组
   - 填写用户名（例如：heizi2025）
   - 填写密码（例如：Heizi8888）
   - 填写其他必填字段

7. 点击"确定"保存

8. 观察提示消息：
   - 应该先显示"账号创建成功"
   - 然后显示"正在自动获取限额信息..."
   - 最后显示"限额信息已自动获取并保存"

9. 编辑刚创建的账号，切换到"限额设置"标签

10. 验证限额字段是否已自动填充

#### 测试手动获取（编辑账号）

1. 在账号管理页面，点击编辑某个账号

2. 切换到"限额设置"标签页

3. 点击页面顶部的"获取限额"按钮

4. 观察提示消息：
   - 应该显示"正在登录皇冠获取限额信息..."
   - 然后显示"限额信息获取成功！"

5. 验证表单中的限额字段是否已更新

## 测试场景

### 场景 1: 正常流程（成功）

**步骤**：
1. 使用正确的账号密码创建新账号
2. 系统自动获取限额

**预期结果**：
- 账号创建成功
- 限额自动获取并保存
- 显示成功消息

### 场景 2: 账号密码错误

**步骤**：
1. 使用错误的账号密码创建新账号
2. 系统尝试自动获取限额

**预期结果**：
- 账号创建成功
- 限额获取失败
- 显示警告消息："账号创建成功，但限额获取失败: 登录失败"
- 用户可以稍后手动获取或直接输入限额

### 场景 3: 网络问题

**步骤**：
1. 断开网络连接
2. 创建新账号

**预期结果**：
- 账号创建成功
- 限额获取失败
- 显示警告消息："账号创建成功，但限额获取失败，请稍后手动获取"

### 场景 4: 手动重新获取

**步骤**：
1. 编辑一个已存在的账号
2. 切换到限额设置标签
3. 点击"获取限额"按钮

**预期结果**：
- 显示加载状态
- 限额数据自动填充到表单
- 显示成功消息

## 验证数据正确性

### 通过数据库验证

```sql
-- 查看账号的限额信息
SELECT 
    id,
    username,
    football_prematch_limit,
    football_live_limit,
    basketball_prematch_limit,
    basketball_live_limit
FROM crown_accounts
WHERE username = 'heizi2025';
```

### 通过 API 验证

```bash
# 获取 token
TOKEN="your_jwt_token_here"

# 获取账号列表
curl -H "Authorization: Bearer $TOKEN" \
     http://localhost:3001/api/accounts

# 获取特定账号的限额
curl -X POST \
     -H "Authorization: Bearer $TOKEN" \
     http://localhost:3001/api/crown-automation/fetch-limits/1
```

## 常见问题

### Q1: 测试脚本报错 "Cannot find module"

**解决方案**：
```bash
cd backend
npm run build
```

### Q2: 限额获取失败

**可能原因**：
1. 账号密码错误
2. 皇冠网站无法访问
3. 网络连接问题
4. 皇冠网站页面结构发生变化

**解决方案**：
1. 检查账号密码是否正确
2. 尝试直接访问皇冠网站
3. 检查网络连接
4. 查看后端日志，确认具体错误

### Q3: 自动获取没有触发

**可能原因**：
1. 前端代码未正确部署
2. API 请求失败

**解决方案**：
1. 检查浏览器控制台是否有错误
2. 检查后端日志
3. 确认 API 接口是否正常工作

## 日志查看

### 后端日志

后端会输出详细的日志信息：

```
🔍 开始获取账号 heizi2025 的限额信息...
✅ 登录成功，正在获取限额页面...
📊 解析的限额数据: { football: { prematch: 200000, live: 200000 }, basketball: { prematch: 200000, live: 200000 } }
✅ 成功获取限额信息
```

### 前端日志

打开浏览器开发者工具（F12），查看 Console 标签：

```
[API] request { method: 'post', url: 'http://localhost:3001/api/crown-automation/fetch-limits/1', hasToken: true }
```

## 性能测试

### 测试获取限额的时间

```javascript
// 在浏览器控制台运行
const start = Date.now();
await fetch('/api/crown-automation/fetch-limits/1', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('token')
  }
});
console.log('耗时:', Date.now() - start, 'ms');
```

**预期结果**：通常在 3-5 秒之间

## 总结

通过以上测试方法，可以全面验证限额获取功能的正确性和稳定性。建议在以下情况下进行测试：

1. ✅ 首次部署后
2. ✅ 修改相关代码后
3. ✅ 皇冠网站更新后
4. ✅ 定期回归测试

如果测试失败，请查看日志并根据错误信息进行排查。

