# 如何更新系统 - 限额自动获取功能

## 🎯 更新内容

本次更新添加了**账号限额自动获取功能**：
- ✅ 新增账号时自动从皇冠网站获取限额
- ✅ 编辑账号时可以手动获取限额
- ✅ 自动保存到数据库
- ✅ 友好的用户提示

## 📦 更新方法

### 方法 1: 一键更新（推荐）⭐

**最简单的方法，适合所有用户**

```bash
# 进入项目目录
cd /Users/lt/Documents/kaifa/bclogin-system

# 运行更新脚本
bash update.sh
```

脚本会自动完成：
1. ✅ 拉取最新代码
2. ✅ 安装依赖
3. ✅ 编译后端
4. ✅ 重启服务
5. ✅ 运行测试

### 方法 2: 手动更新

**适合需要精细控制的用户**

#### 步骤 1: 拉取代码

```bash
cd /Users/lt/Documents/kaifa/bclogin-system
git pull origin main
```

#### 步骤 2: 安装依赖

```bash
# 后端
cd backend
npm install

# 前端
cd ../frontend
npm install
```

#### 步骤 3: 编译后端

```bash
cd backend
npm run build
```

#### 步骤 4: 重启服务

**如果使用 PM2**:
```bash
pm2 restart all
```

**如果使用开发模式**:
```bash
# 终端 1
cd backend
npm run dev

# 终端 2
cd frontend
npm run dev
```

#### 步骤 5: 测试功能

```bash
cd backend
node backend/test-fetch-limits.js
```

## ✅ 验证更新

### 1. 检查代码版本

```bash
git log --oneline -1
```

应该显示：
```
7d49083 feat: 实现账号限额自动获取功能
```

### 2. 测试后端功能

```bash
cd backend
node backend/test-fetch-limits.js
```

应该显示：
```
🧪 开始测试限额获取功能...
✅ 登录成功
✅ 限额页面获取成功
✅ 找到足球限额表格
✅ 找到篮球限额表格
✅ 测试完成！限额获取功能正常工作
```

### 3. 测试前端功能

1. 打开浏览器访问系统
2. 登录账号
3. 进入"账号管理"
4. 点击"添加账号"
5. 填写账号信息并保存
6. 观察是否显示"正在自动获取限额信息..."
7. 验证是否显示"限额信息已自动获取并保存"

## 🔧 常见问题

### Q1: git pull 提示有冲突怎么办？

**解决方案**:
```bash
# 保存本地修改
git stash

# 拉取最新代码
git pull origin main

# 恢复本地修改
git stash pop
```

### Q2: npm install 失败怎么办？

**解决方案**:
```bash
# 清除缓存
npm cache clean --force

# 删除 node_modules
rm -rf node_modules package-lock.json

# 重新安装
npm install
```

### Q3: 编译失败怎么办？

**解决方案**:
```bash
# 删除编译输出
rm -rf dist

# 重新编译
npm run build
```

### Q4: PM2 重启失败怎么办？

**解决方案**:
```bash
# 查看进程列表
pm2 list

# 如果没有进程，重新启动
cd backend
pm2 start npm --name "backend" -- run dev

cd ../frontend
pm2 start npm --name "frontend" -- run dev
```

### Q5: 更新后功能不正常怎么办？

**解决方案**:
```bash
# 1. 查看后端日志
tail -f backend/logs/app.log

# 2. 查看 PM2 日志
pm2 logs backend

# 3. 重新编译和重启
cd backend
npm run build
pm2 restart all

# 4. 清除浏览器缓存
# 在浏览器中按 Ctrl+Shift+R (硬刷新)
```

## 🔄 回滚到之前版本

如果更新后出现问题，可以回滚：

```bash
# 1. 查看提交历史
git log --oneline

# 2. 回滚到上一个版本
git reset --hard b199e02

# 3. 重新编译
cd backend
npm run build

# 4. 重启服务
pm2 restart all
```

## 📊 更新后的新功能

### 自动获取限额（新增账号）

1. 进入"账号管理"页面
2. 点击"添加账号"
3. 填写账号信息（用户名、密码等）
4. 点击"确定"
5. **系统自动获取限额** ⭐
6. 显示"限额信息已自动获取并保存"

### 手动获取限额（编辑账号）

1. 进入"账号管理"页面
2. 点击编辑某个账号
3. 切换到"限额设置"标签
4. 点击"获取限额"按钮
5. **自动填充限额信息** ⭐
6. 点击"确定"保存

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `QUICK_REFERENCE_LIMITS.md` | 快速参考指南 ⭐ |
| `DEPLOYMENT_GUIDE.md` | 详细部署指南 |
| `TEST_FETCH_LIMITS.md` | 测试指南 |
| `docs/fetch-limits-feature.md` | 功能详细文档 |
| `CHANGELOG_LIMITS_FEATURE.md` | 变更日志 |

## 💡 更新建议

### 更新前

- ✅ 备份重要数据
- ✅ 确保网络连接正常
- ✅ 关闭正在运行的服务

### 更新中

- ✅ 按照步骤逐步执行
- ✅ 注意查看错误信息
- ✅ 遇到问题及时查看文档

### 更新后

- ✅ 运行测试脚本验证
- ✅ 测试前端功能
- ✅ 查看日志确认无错误

## 🎉 更新完成

更新完成后，你将拥有：

✅ **自动化**: 新增账号时自动获取限额  
✅ **便捷性**: 编辑账号时一键更新限额  
✅ **准确性**: 直接从皇冠网站获取最新数据  
✅ **友好性**: 清晰的提示和错误处理  

现在可以更高效地管理账号限额了！

## 📞 需要帮助？

如果遇到问题：

1. 查看 [常见问题](#常见问题) 部分
2. 查看 [部署指南](DEPLOYMENT_GUIDE.md)
3. 查看后端日志: `tail -f backend/logs/app.log`
4. 查看 PM2 日志: `pm2 logs backend`

---

**更新日期**: 2025-10-28  
**版本**: v1.0.0  
**Git Commit**: 7d49083

