# 宝塔面板更新指南 - 限额自动获取功能

## 🎯 更新内容

本次更新添加了**账号限额自动获取功能**：
- ✅ 新增账号时自动从皇冠网站获取限额
- ✅ 编辑账号时可以手动获取限额
- ✅ 自动保存到数据库
- ✅ 友好的用户提示

## 🖥️ 服务器信息

- **服务器IP**: 47.238.112.207
- **用户名**: root
- **密码**: latiao@2025
- **项目目录**: /www/wwwroot/aibcbot.top
- **访问地址**: https://aibcbot.top
- **管理面板**: 宝塔面板

## 🚀 更新步骤（宝塔面板）

### 方法 1: 使用宝塔终端（推荐）⭐

#### 步骤 1: 登录宝塔面板

1. 打开浏览器访问宝塔面板
2. 输入用户名和密码登录

#### 步骤 2: 打开终端

1. 在宝塔面板左侧菜单找到 **"终端"** 或 **"SSH终端"**
2. 点击打开终端

#### 步骤 3: 进入项目目录

```bash
cd /www/wwwroot/aibcbot.top
```

#### 步骤 4: 运行更新脚本

```bash
bash server-update.sh
```

**就这么简单！** 脚本会自动完成所有更新步骤。

### 方法 2: 使用宝塔文件管理器 + 终端

#### 步骤 1: 打开文件管理器

1. 在宝塔面板左侧菜单点击 **"文件"**
2. 导航到 `/www/wwwroot/aibcbot.top`

#### 步骤 2: 打开终端

1. 在文件管理器顶部点击 **"终端"** 按钮
2. 或者右键点击目录，选择 **"打开终端"**

#### 步骤 3: 拉取最新代码

```bash
git pull origin main
```

#### 步骤 4: 更新后端

```bash
cd backend
npm install
npm run build
```

#### 步骤 5: 重启后端服务

在宝塔面板中：
1. 点击左侧菜单 **"软件商店"**
2. 找到 **"PM2管理器"**
3. 点击 **"设置"**
4. 找到 `bclogin-backend` 进程
5. 点击 **"重启"** 按钮

或者使用命令：
```bash
/www/server/nodejs/v22.18.0/bin/pm2 restart bclogin-backend
```

#### 步骤 6: 更新前端

```bash
cd ../frontend
npm install
npm run build
```

#### 步骤 7: 重启 Nginx

在宝塔面板中：
1. 点击左侧菜单 **"软件商店"**
2. 找到 **"Nginx"**
3. 点击 **"重载配置"** 或 **"重启"**

或者使用命令：
```bash
nginx -s reload
```

### 方法 3: 使用宝塔计划任务（自动更新）

#### 创建更新任务

1. 在宝塔面板左侧菜单点击 **"计划任务"**
2. 点击 **"添加计划任务"**
3. 填写以下信息：
   - **任务类型**: Shell脚本
   - **任务名称**: 更新限额功能
   - **执行周期**: 根据需要选择（建议手动执行）
   - **脚本内容**:
   ```bash
   cd /www/wwwroot/aibcbot.top
   bash server-update.sh
   ```
4. 点击 **"添加任务"**
5. 需要更新时，点击任务右侧的 **"执行"** 按钮

## 📱 使用宝塔手机APP更新

如果你安装了宝塔手机APP：

1. 打开宝塔APP
2. 选择你的服务器
3. 点击 **"终端"**
4. 输入命令：
   ```bash
   cd /www/wwwroot/aibcbot.top && bash server-update.sh
   ```
5. 等待更新完成

## ✅ 验证更新

### 1. 在宝塔面板查看服务状态

#### 查看 PM2 进程

1. 点击 **"软件商店"**
2. 找到 **"PM2管理器"**
3. 点击 **"设置"**
4. 查看 `bclogin-backend` 状态是否为 **"运行中"**

#### 查看 Nginx 状态

1. 点击 **"软件商店"**
2. 找到 **"Nginx"**
3. 查看状态是否为 **"运行中"**

### 2. 测试后端功能

在宝塔终端中执行：
```bash
cd /www/wwwroot/aibcbot.top/backend
node backend/test-fetch-limits.js
```

应该显示：
```
🧪 开始测试限额获取功能...
✅ 登录成功
✅ 限额页面获取成功
✅ 找到足球限额表格
✅ 找到篮球限额表格
✅ 测试完成！限额获取功能正常工作
```

### 3. 测试前端功能

1. 打开浏览器访问 **https://aibcbot.top**
2. 登录系统（用户名: zhuren, 密码: 123456）
3. 进入"账号管理"页面
4. 点击"添加账号"
5. 填写账号信息并保存
6. 观察是否显示"正在自动获取限额信息..."
7. 验证是否显示"限额信息已自动获取并保存"

## 🔍 查看日志

### 在宝塔面板查看日志

#### 查看 PM2 日志

1. 点击 **"软件商店"**
2. 找到 **"PM2管理器"**
3. 点击 **"设置"**
4. 找到 `bclogin-backend` 进程
5. 点击 **"日志"** 按钮

#### 查看 Nginx 日志

1. 点击 **"网站"**
2. 找到 `aibcbot.top`
3. 点击 **"设置"**
4. 点击 **"日志"** 标签
5. 查看访问日志或错误日志

### 使用终端查看日志

```bash
# 查看 PM2 日志
/www/server/nodejs/v22.18.0/bin/pm2 logs bclogin-backend --lines 50

# 查看 Nginx 访问日志
tail -f /www/wwwlogs/aibcbot.top.log

# 查看 Nginx 错误日志
tail -f /www/wwwlogs/aibcbot.top.error.log
```

## 🐛 故障排除

### 问题 1: 找不到 git 命令

**解决方案**：

在宝塔面板中安装 Git：
1. 点击 **"软件商店"**
2. 搜索 **"Git"**
3. 点击 **"安装"**

或者使用命令：
```bash
yum install git -y
```

### 问题 2: npm install 失败

**解决方案**：

1. 在宝塔面板中检查 Node.js 版本：
   - 点击 **"软件商店"**
   - 找到 **"Node版本管理器"**
   - 确保安装了 v22.18.0

2. 清除缓存：
   ```bash
   npm cache clean --force
   rm -rf node_modules package-lock.json
   npm install
   ```

### 问题 3: PM2 重启失败

**解决方案**：

1. 在宝塔面板中：
   - 点击 **"软件商店"**
   - 找到 **"PM2管理器"**
   - 点击 **"设置"**
   - 找到 `bclogin-backend`
   - 点击 **"删除"**
   - 然后重新添加进程

2. 或者使用命令：
   ```bash
   /www/server/nodejs/v22.18.0/bin/pm2 delete bclogin-backend
   cd /www/wwwroot/aibcbot.top/backend
   /www/server/nodejs/v22.18.0/bin/pm2 start npm --name "bclogin-backend" -- run start
   ```

### 问题 4: 权限问题

**错误信息**：
```
Permission denied
```

**解决方案**：

在宝塔终端中执行：
```bash
# 修改项目目录权限
chown -R www:www /www/wwwroot/aibcbot.top

# 或者使用 root 权限
chmod -R 755 /www/wwwroot/aibcbot.top
```

### 问题 5: 端口被占用

**解决方案**：

1. 在宝塔面板中：
   - 点击 **"安全"**
   - 检查端口 3001 是否开放
   - 如果没有，点击 **"放行端口"** 添加

2. 或者使用命令：
   ```bash
   # 查看端口占用
   netstat -tunlp | grep 3001
   
   # 如果被占用，杀死进程
   kill -9 <PID>
   ```

## 🔄 回滚步骤

### 使用宝塔文件管理器回滚

1. 在宝塔面板点击 **"文件"**
2. 导航到 `/www/wwwroot/aibcbot.top`
3. 找到备份文件 `backup-*.tar.gz`
4. 右键点击，选择 **"解压"**
5. 在终端中执行：
   ```bash
   cd /www/wwwroot/aibcbot.top/backend
   npm run build
   /www/server/nodejs/v22.18.0/bin/pm2 restart bclogin-backend
   ```

### 使用 Git 回滚

在宝塔终端中执行：
```bash
cd /www/wwwroot/aibcbot.top
git log --oneline -10
git reset --hard b199e02
cd backend && npm run build
/www/server/nodejs/v22.18.0/bin/pm2 restart bclogin-backend
```

## 📊 宝塔面板监控

### 设置监控告警

1. 点击 **"监控"**
2. 查看服务器资源使用情况
3. 设置告警规则：
   - CPU 使用率 > 80%
   - 内存使用率 > 80%
   - 磁盘使用率 > 80%

### 查看实时状态

1. 点击 **"首页"**
2. 查看：
   - CPU 使用率
   - 内存使用率
   - 磁盘使用率
   - 网络流量

## 🎯 新功能使用

### 自动获取（新增账号）

1. 访问 https://aibcbot.top
2. 登录系统
3. 进入"账号管理"
4. 点击"添加账号"
5. 填写账号信息（用户名、密码等）
6. 点击"确定"
7. **系统自动获取限额** ⭐
8. 显示"限额信息已自动获取并保存"

### 手动获取（编辑账号）

1. 在账号列表中点击"编辑"
2. 切换到"限额设置"标签
3. 点击"获取限额"按钮
4. **自动填充限额** ⭐
5. 点击"确定"保存

## 📚 相关文档

| 文档 | 说明 |
|------|------|
| `宝塔更新指南.md` | 本文档 ⭐⭐⭐⭐⭐ |
| `服务器更新指南.md` | 通用服务器更新指南 |
| `QUICK_REFERENCE_LIMITS.md` | 快速参考指南 |
| `SERVER_CONFIG.md` | 服务器配置信息 |

## 💡 宝塔面板小技巧

### 1. 快速访问终端

在文件管理器中，右键点击项目目录，选择 **"打开终端"**

### 2. 一键备份

1. 点击 **"计划任务"**
2. 添加备份任务
3. 定期备份网站和数据库

### 3. 快速重启服务

在软件商店中，找到对应服务，点击 **"重启"** 按钮

### 4. 查看实时日志

在 PM2 管理器中，点击 **"日志"** 可以实时查看应用日志

## 🎉 总结

使用宝塔面板更新非常简单：

✅ **图形化界面** - 无需记忆复杂命令  
✅ **一键操作** - 点击按钮即可完成  
✅ **实时监控** - 随时查看服务状态  
✅ **日志管理** - 方便查看和分析  

**推荐更新方式**：
```bash
# 在宝塔终端中执行
cd /www/wwwroot/aibcbot.top
bash server-update.sh
```

就这么简单！🚀

---

**更新日期**: 2025-10-28  
**版本**: v1.0.0  
**服务器**: 47.238.112.207  
**管理面板**: 宝塔面板  
**项目目录**: /www/wwwroot/aibcbot.top

