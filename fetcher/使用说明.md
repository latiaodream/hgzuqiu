# 皇冠赛事抓取服务 - 使用说明

## 功能介绍

本服务直接从皇冠 API 抓取赛事数据，支持三种类型：

- **滚球**：正在进行的比赛
- **今日**：今天的比赛  
- **早盘**：明天及以后的比赛

每次抓取会自动获取这三种类型的赛事，合并后保存到一个文件中。

## 快速开始

### 第一步：配置账号

```bash
cd fetcher
cp .env.example .env
nano .env
```

修改以下内容：
```env
CROWN_USERNAME=你的皇冠账号
CROWN_PASSWORD=你的皇冠密码
```

保存退出（按 Ctrl+X，然后按 Y，最后按 Enter）

### 第二步：启动服务

```bash
./start.sh
```

看到以下输出表示启动成功：
```
✅ 服务已启动
┌─────┬──────────────────┬─────────┬─────────┬─────────┐
│ id  │ name             │ status  │ restart │ uptime  │
├─────┼──────────────────┼─────────┼─────────┼─────────┤
│ 0   │ crown-fetcher    │ online  │ 0       │ 0s      │
└─────┴──────────────────┴─────────┴─────────┴─────────┘
```

### 第三步：查看日志

```bash
pm2 logs crown-fetcher
```

应该看到类似输出：
```
✅ [14:30:15] 滚球抓取成功 | 比赛数: 45
✅ [14:30:16] 今日抓取成功 | 比赛数: 60
✅ [14:30:17] 早盘抓取成功 | 比赛数: 45
✅ [14:30:17] 总计: 150 场 (滚球: 45, 今日: 60, 早盘: 45) | 成功率: 100.0%
```

## 常用命令

### 服务管理

```bash
# 启动服务
./start.sh

# 停止服务
./stop.sh

# 重启服务
pm2 restart crown-fetcher

# 查看状态
pm2 status

# 查看日志（实时）
pm2 logs crown-fetcher

# 查看最近100行日志
pm2 logs crown-fetcher --lines 100
```

### 数据查看

```bash
# 查看比赛总数
cat data/latest-matches.json | jq '.matchCount'

# 查看各类型比赛数量
cat data/latest-matches.json | jq '.breakdown'

# 查看最后更新时间
cat data/latest-matches.json | jq '.timestamp'
```

## 配置说明

### 环境变量（.env 文件）

```env
# 皇冠账号（必填）
CROWN_USERNAME=your_username
CROWN_PASSWORD=your_password

# 皇冠站点（选择可用的）
CROWN_BASE_URL=https://hga026.com

# 抓取间隔（毫秒，建议3000-5000）
FETCH_INTERVAL=3000

# 会话检查间隔（毫秒，默认5分钟）
SESSION_CHECK_INTERVAL=300000

# 数据目录
DATA_DIR=./data
```

### 备用站点

如果主站点无法访问，可以尝试以下备用站点：

```
hga026.com
hga027.com
hga030.com
hga035.com
hga038.com
hga039.com
hga050.com
mos011.com
mos022.com
mos033.com
mos055.com
mos066.com
mos100.com
```

修改方法：
```bash
nano .env
# 修改 CROWN_BASE_URL=https://hga027.com
pm2 restart crown-fetcher
```

## 监控

### 查看运行状态

```bash
pm2 status
```

### 查看实时日志

```bash
pm2 logs crown-fetcher
```

### 查看统计信息

服务每分钟会自动打印统计信息：

```
📊 运行统计
============================================================
⏱️  运行时长: 1小时 23分钟 45秒
📈 总抓取次数: 276
✅ 成功次数: 275
❌ 失败次数: 1
📊 成功率: 99.6%
🔐 登录次数: 1
⚽ 最新比赛数: 150 (滚球: 45, 今日: 60, 早盘: 45)
🕐 最后抓取: 2025-11-06 14:30:17
============================================================
```

## 故障排查

### 问题1：登录失败

**症状：** 日志显示 "❌ 登录失败: 账号或密码错误"

**解决方法：**
1. 检查 .env 文件中的账号密码是否正确
2. 尝试更换备用站点
3. 确认账号未被锁定

```bash
# 检查配置
cat .env | grep CROWN_

# 修改配置
nano .env

# 重启服务
pm2 restart crown-fetcher
```

### 问题2：抓取失败

**症状：** 日志显示 "❌ 抓取失败"

**解决方法：**
1. 检查网络连接
2. 查看详细日志找出原因
3. 尝试重启服务

```bash
# 查看详细日志
pm2 logs crown-fetcher --lines 50

# 重启服务
pm2 restart crown-fetcher
```

### 问题3：数据不更新

**症状：** data/latest-matches.json 时间戳不更新

**解决方法：**
1. 检查服务是否正常运行
2. 查看日志是否有错误
3. 重启服务

```bash
# 检查服务状态
pm2 status

# 查看日志
pm2 logs crown-fetcher --lines 50

# 重启服务
pm2 restart crown-fetcher
```

### 问题4：会话过期

**症状：** 日志显示 "⚠️ 检测到重复登录，会话已失效"

**解决方法：**
- 服务会自动重新登录，无需手动处理
- 如果频繁出现，检查是否有其他程序使用同一账号

## 性能优化

### 调整抓取间隔

根据需求调整 FETCH_INTERVAL：

- **高频更新**：3000ms（3秒）- 适合滚球实时性要求高
- **标准更新**：5000ms（5秒）- 平衡性能和实时性
- **低频更新**：10000ms（10秒）- 减少服务器负载

修改方法：
```bash
nano .env
# 修改 FETCH_INTERVAL=5000
pm2 restart crown-fetcher
```

### 清理日志

定期清理日志文件：
```bash
# 清空 PM2 日志
pm2 flush crown-fetcher

# 或手动删除
rm -f logs/*.log
```

## 与主程序集成

主程序会自动读取 `fetcher/data/latest-matches.json` 文件。

### 验证集成

1. 确保 fetcher 服务正常运行
2. 启动主程序后端
3. 访问赛事管理页面
4. 切换不同的赛事类型（滚球、今日、早盘）
5. 应该能看到对应类型的赛事

### 数据优先级

后端读取数据的优先级：
1. `fetcher-isports/data/latest-matches.json`（iSports 数据）
2. `fetcher/data/latest-matches.json`（皇冠数据）

如果要使用皇冠数据，需要停止 iSports 抓取服务：
```bash
cd ../fetcher-isports
pm2 stop isports-fetcher
```

## 停止服务

### 临时停止

```bash
./stop.sh
# 或
pm2 stop crown-fetcher
```

### 完全删除

```bash
pm2 delete crown-fetcher
```

## 更新服务

```bash
# 停止服务
pm2 stop crown-fetcher

# 拉取最新代码
git pull

# 重新编译
npm run build

# 启动服务
pm2 start crown-fetcher
```

## 获取帮助

- **快速开始**：查看 `QUICK_START.md`
- **部署指南**：查看 `DEPLOY.md`
- **完整文档**：查看 `README.md`
- **更新日志**：查看 `CHANGELOG.md`

## 技术支持

如遇到问题，请提供以下信息：

1. 服务状态：`pm2 status`
2. 最近日志：`pm2 logs crown-fetcher --lines 50`
3. 配置信息：`cat .env`（隐藏密码）
4. 错误信息：完整的错误日志

