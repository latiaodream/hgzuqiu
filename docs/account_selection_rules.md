# Crown Account Selection & Betting Rules

> 本文档用于记录 2025-02-XX 与业务确认的优选/下注规则，后续开发与联调若有调整请同步更新。

## 时间边界

- **统计窗口**：所有与“止盈”“有效金额”“输赢”相关的统计均以每日中午 **12:00** 为界。
- **重置逻辑**：跨过 12:00 即视为下一统计日；当周亏盈统计需结合业务侧定义的周起止（默认按自然周，周一 12:00 起至下周一 11:59），若后续有新要求需在实现时确认。

## 关键术语

- **止盈金额 (`stop_profit_limit`)**：新增字段，账号当日累积盈利达到该值后停止自动下注。
- **有效金额**：当日已经下注 + 已结算金额的总和（使用 12:00 边界）。
- **同线账号**：皇冠原始账号首四位字母/数字相同的账号，代表同一条线。

## 账号优选流程

当池子里存在 N 个账号（示例 50 个）时，点击“优选”进行下注账号筛选，遵循如下步骤（优先级从高到低）：

1. **止盈校验**
   - 排除所有已达止盈金额的账号。

2. **同线赛事互斥**
   - 对于目标赛事，仅允许同一条线中的一个账号下注。
   - 业务场景：已通过优选在某场下注让球后，如需追加同场大小盘，仅出现两次操作的这种情况，依旧必须保证同线只出一单。

3. **有效金额排序**
   - 在剩余账号中，按照当日有效金额从小到大排序，优先选择有效金额最低的账号。

4. **亏损优先**
   - 同一有效金额区间内，优先选择当日或当周净亏损的账号。（优先顺序：当日亏损 > 当周亏损 > 其他）

> 以上规则按顺序执行，不同优先级发生冲突时以前一条规则为准。

## 实施注意事项

- 盈亏统计口径（实时盈亏、已结算盈亏、是否包含未结算浮动）需在开发阶段与风控再次确认。
- “当周”边界目前暂按自然周，若出现节假日 / 自定义周起始需支持配置。
- 后续投注模块落地时需验证：同场让球 + 大小是否作为同一事务提交或两笔请求处理，对幂等逻辑有影响。
- 如果未来增加其它优选维度（如线路负荷、代理状态），请在此文档追加说明并同步实现。

## 实现方案草案

- **边界时间计算**：
  - 当日统计起点：若当前时间 ≥ 12:00，则取当日 12:00；否则取上一日 12:00。
  - 当周统计起点：以“当日统计起点”所在周的周一 12:00 为起点（周一=1，周日=0）。
- **数据源**：
  - `bets` 表：
    - 有效金额 = `SUM(bet_amount)`（排除 `status = 'cancelled'`），范围 `created_at >= 当日起点`。
    - 日盈亏 = `SUM(profit_loss)`，范围 `settled_at >= 当日起点` 且 `status = 'settled'`。
    - 周盈亏 = 同上但范围 `settled_at >= 当周起点`。
  - 止盈校验：当 `stop_profit_limit > 0` 且 `日盈亏 >= limit` 时排除账号。
- **线路判定**：优先使用 `original_username`，若缺失则回退 `username`；取首四字符（统一转大写）作为线路键。
- **排序权重**：
  1. `daily_effective_amount` 升序。
  2. 同金额下按亏损优先：`daily_profit < 0` → 桶 0；否则若 `weekly_profit < 0` → 桶 1；其余 → 桶 2。
  3. 仍相同时按账号 ID 升序。
- **同线互斥**：
  - 查询目标 `match_id` 既有下注记录（排除取消单），生成“线路 → 已下注玩法列表”。
  - 当前迭代先实现“同线同场只取一个账号”，若后续需要区分玩法再扩展。

## 更新记录

- 2025-02-XX：首次记录（依据业务说明）。
