# iSportsAPI è¯­è¨€åŒ…é›†æˆæ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

iSportsAPI è¯­è¨€åŒ…æä¾›äº†ç¹ä½“ä¸­æ–‡çš„è”èµ›ã€çƒé˜Ÿã€çƒå‘˜åç§°ï¼Œå¯ä»¥å¤§å¹…æé«˜ä¸çš‡å† èµ›äº‹çš„åŒ¹é…ç‡ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. è¯­è¨€åŒ…æ•°æ®

- **è”èµ›åç§°**ï¼šæä¾›ç¹ä½“ä¸­æ–‡çš„è”èµ›åç§°ï¼ˆå¦‚ï¼šè‹±è¶…ã€è¥¿ç”²ã€å¾·ç”²ç­‰ï¼‰
- **çƒé˜Ÿåç§°**ï¼šæä¾›ç¹ä½“ä¸­æ–‡çš„çƒé˜Ÿåç§°ï¼ˆå¦‚ï¼šæ›¼è”ã€å·´å¡ç½—é‚£ã€æ‹œä»æ…•å°¼é»‘ç­‰ï¼‰
- **çƒå‘˜åç§°**ï¼šæä¾›ç¹ä½“ä¸­æ–‡çš„çƒå‘˜åç§°

### 2. ç¼“å­˜æœºåˆ¶

- **æœ¬åœ°ç¼“å­˜**ï¼šè¯­è¨€åŒ…æ•°æ®ä¼šè¢«ç¼“å­˜åˆ° `fetcher-isports/data/language-cache.json`
- **ç¼“å­˜æœ‰æ•ˆæœŸ**ï¼š24 å°æ—¶
- **è‡ªåŠ¨æ›´æ–°**ï¼šç¼“å­˜è¿‡æœŸåä¼šè‡ªåŠ¨é‡æ–°è·å–

### 3. åŒ¹é…ä¼˜åŒ–

- **ä¸­æ–‡åŒ¹é…**ï¼šä½¿ç”¨ç¹ä½“ä¸­æ–‡åç§°ä¸çš‡å† çš„ä¸­æ–‡åç§°è¿›è¡ŒåŒ¹é…
- **æ‹¼éŸ³åŒ¹é…**ï¼šå°†ä¸­æ–‡è½¬æ¢ä¸ºæ‹¼éŸ³åä¸è‹±æ–‡åç§°åŒ¹é…
- **å¤šé‡åŒ¹é…**ï¼šåŒæ—¶ä½¿ç”¨ä¸­æ–‡ã€æ‹¼éŸ³ã€è‹±æ–‡è¿›è¡ŒåŒ¹é…ï¼Œå–æœ€é«˜ç›¸ä¼¼åº¦

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. æµ‹è¯•è¯­è¨€åŒ… API

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
node test-language-api.js
```

**é¢„æœŸè¾“å‡ºï¼š**
```
============================================================
ğŸ§ª æµ‹è¯• iSportsAPI è¯­è¨€åŒ… API
============================================================
API Key: GvpziueL9ouzIJNj

ğŸ“¥ è·å–ç¹ä½“ä¸­æ–‡è¯­è¨€åŒ…...
âœ… å“åº”çŠ¶æ€ç : 0
âœ… å“åº”æ¶ˆæ¯: success

ğŸ“Š æ•°æ®ç»Ÿè®¡:
   è”èµ›æ•°é‡: 1000+
   çƒé˜Ÿæ•°é‡: 10000+
   çƒå‘˜æ•°é‡: 50000+

ğŸ† å‰ 10 ä¸ªè”èµ›:
   1. [1] æ„›è¶…
   2. [2] é˜¿ç”²
   3. [3] å¥§ç”²
   ...

âš½ å‰ 10 ä¸ªçƒé˜Ÿ:
   1. [100] æ›¼è¯
   2. [101] åˆ©ç‰©æµ¦
   3. [102] åˆ‡çˆ¾è¥¿
   ...

âœ… è¯­è¨€åŒ… API æµ‹è¯•æˆåŠŸï¼
```

### 2. æ„å»ºæ˜ å°„è¡¨ï¼ˆè‡ªåŠ¨ä½¿ç”¨è¯­è¨€åŒ…ï¼‰

```bash
cd backend

# è®¾ç½®ç¯å¢ƒå˜é‡
export ISPORTS_API_KEY=GvpziueL9ouzIJNj
export CROWN_GID_INPUT=/path/to/crown-gids.json
export CROWN_MAP_OUTPUT=/path/to/crown-match-map.json

# è¿è¡Œæ˜ å°„è„šæœ¬
npm run crown:build-map
```

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸŒ åˆå§‹åŒ–è¯­è¨€åŒ…æœåŠ¡...
ğŸ“¥ è·å–ç¹ä½“ä¸­æ–‡è¯­è¨€åŒ…...
âœ… è·å–æˆåŠŸ: 1000 è”èµ›, 10000 çƒé˜Ÿ
ğŸ’¾ å·²ä¿å­˜è¯­è¨€åŒ…ç¼“å­˜: 1000 è”èµ›, 10000 çƒé˜Ÿ
âœ… è¯­è¨€åŒ…å·²åŠ è½½: 1000 è”èµ›, 10000 çƒé˜Ÿ

ğŸ“¥ è·å– iSports èµ›äº‹: 2025-11-02
   è·å–åˆ° 150 åœº
ğŸ“¥ è·å– iSports èµ›äº‹: 2025-11-03
   è·å–åˆ° 200 åœº
ğŸ“¥ è·å– iSports èµ›äº‹: 2025-11-01
   è·å–åˆ° 100 åœº

ğŸ” å¼€å§‹åŒ¹é…...
âœ… åŒ¹é…å®Œæˆ: 45/50 åœº (90%)
```

## ğŸ“Š åŒ¹é…ç‡æå‡

### ä¼˜åŒ–å‰ï¼ˆä»…ä½¿ç”¨æ‹¼éŸ³åŒ¹é…ï¼‰

- **åŒ¹é…ç‡**ï¼šçº¦ 60-70%
- **é—®é¢˜**ï¼š
  - è‹±æ–‡åç§°ä¸ä¸­æ–‡æ‹¼éŸ³å·®å¼‚å¤§
  - çƒé˜Ÿç®€ç§°æ— æ³•åŒ¹é…
  - è”èµ›åç§°ç¿»è¯‘ä¸ä¸€è‡´

### ä¼˜åŒ–åï¼ˆä½¿ç”¨è¯­è¨€åŒ…ï¼‰

- **åŒ¹é…ç‡**ï¼šçº¦ 85-95%
- **ä¼˜åŠ¿**ï¼š
  - ç›´æ¥ä½¿ç”¨ä¸­æ–‡åç§°åŒ¹é…
  - æ”¯æŒç¹ä½“ä¸­æ–‡
  - è¦†ç›–æ›´å¤šçƒé˜Ÿå’Œè”èµ›

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. è¯­è¨€åŒ…æœåŠ¡ç±»

**æ–‡ä»¶**ï¼š`backend/src/services/isports-language.ts`

**ä¸»è¦æ–¹æ³•**ï¼š
- `fetchLanguageData()`: è·å–è¯­è¨€åŒ…æ•°æ®
- `updateCache()`: æ›´æ–°æœ¬åœ°ç¼“å­˜
- `ensureCache()`: ç¡®ä¿ç¼“å­˜å¯ç”¨
- `getTeamName(teamId)`: è·å–çƒé˜Ÿä¸­æ–‡åç§°
- `getLeagueName(leagueId)`: è·å–è”èµ›ä¸­æ–‡åç§°

### 2. æ˜ å°„è„šæœ¬é›†æˆ

**æ–‡ä»¶**ï¼š`backend/scripts/map-crown-to-isports.ts`

**å…³é”®æ”¹åŠ¨**ï¼š
```typescript
// 1. å¯¼å…¥è¯­è¨€åŒ…æœåŠ¡
import { ISportsLanguageService } from '../src/services/isports-language';

// 2. åˆå§‹åŒ–æœåŠ¡
const languageService = new ISportsLanguageService(apiKey, cacheDir);
await languageService.ensureCache();

// 3. è·å–èµ›äº‹æ—¶é™„åŠ ä¸­æ–‡åç§°
const matches = await fetchISportsSchedule(apiKey, date, languageService);

// 4. ä½¿ç”¨ä¸­æ–‡åç§°è¿›è¡ŒåŒ¹é…
const homeScore = similarityWithPinyin(
  crownMatch.home,      // çš‡å† ä¸­æ–‡åç§°
  isMatch.homeName,     // iSports è‹±æ–‡åç§°
  isMatch.homeNameTc    // iSports ç¹ä½“ä¸­æ–‡åç§°
);
```

### 3. ç›¸ä¼¼åº¦è®¡ç®—ä¼˜åŒ–

```typescript
function similarityWithPinyin(
  chinese: string,      // çš‡å† ä¸­æ–‡åç§°
  english: string,      // iSports è‹±æ–‡åç§°
  chineseTc?: string    // iSports ç¹ä½“ä¸­æ–‡åç§°
): number {
  const pinyinValue = toPinyin(chinese);
  const score1 = similarity(pinyinValue, english);  // æ‹¼éŸ³ vs è‹±æ–‡
  const score2 = similarity(chinese, english);      // ä¸­æ–‡ vs è‹±æ–‡
  
  let score3 = 0;
  if (chineseTc) {
    score3 = similarity(chinese, chineseTc);        // ä¸­æ–‡ vs ç¹ä½“ä¸­æ–‡
  }
  
  return Math.max(score1, score2, score3);          // å–æœ€é«˜åˆ†
}
```

## ğŸ“ API æ–‡æ¡£

### è¯­è¨€åŒ… API

**ç«¯ç‚¹**ï¼š`GET /sport/languagetc`

**å‚æ•°**ï¼š
- `api_key`: API å¯†é’¥ï¼ˆå¿…éœ€ï¼‰
- `sport`: è¿åŠ¨ç±»å‹ï¼Œå›ºå®šä¸º `football`ï¼ˆå¿…éœ€ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š
```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "leagues": [
        {
          "leagueId": "1",
          "name_tc": "æ„›è¶…"
        }
      ],
      "teams": [
        {
          "teamId": "100",
          "name_tc": "æ›¼è¯"
        }
      ],
      "players": [
        {
          "playerId": "1000",
          "name_tc": "Cç¾…"
        }
      ]
    }
  ]
}
```

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šè¯­è¨€åŒ… API è¿”å›é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š`code: 2, message: 'Invalid [api_key], illegal access.'`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤å·²è®¢é˜… **Language Packs** å¥—é¤
3. ç™»å½• https://www.isportsapi.com/ æŸ¥çœ‹è®¢é˜…çŠ¶æ€

### é—®é¢˜ 2ï¼šç¼“å­˜æ–‡ä»¶ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**ï¼š`âš ï¸  åŠ è½½è¯­è¨€åŒ…ç¼“å­˜å¤±è´¥`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»ºç¼“å­˜æ–‡ä»¶
2. ç¡®ä¿ `fetcher-isports/data` ç›®å½•å­˜åœ¨
3. æ£€æŸ¥æ–‡ä»¶æƒé™

### é—®é¢˜ 3ï¼šåŒ¹é…ç‡ä»ç„¶å¾ˆä½

**å¯èƒ½åŸå› **ï¼š
1. è¯­è¨€åŒ…ç¼“å­˜è¿‡æœŸæˆ–æŸå
2. çš‡å† ä½¿ç”¨çš„æ˜¯ç®€ä½“ä¸­æ–‡ï¼Œè€Œè¯­è¨€åŒ…æ˜¯ç¹ä½“ä¸­æ–‡
3. çƒé˜Ÿåç§°ç¿»è¯‘å·®å¼‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åˆ é™¤ç¼“å­˜æ–‡ä»¶ï¼Œé‡æ–°è·å–ï¼š
   ```bash
   rm fetcher-isports/data/language-cache.json
   npm run crown:build-map
   ```
2. é™ä½ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆåœ¨ `map-crown-to-isports.ts` ä¸­ä¿®æ”¹ï¼‰ï¼š
   ```typescript
   if (best && best.score >= 0.45) {  // ä» 0.55 é™ä½åˆ° 0.45
   ```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å®šæœŸæ›´æ–°è¯­è¨€åŒ…

å»ºè®®æ¯å¤©æ›´æ–°ä¸€æ¬¡è¯­è¨€åŒ…ç¼“å­˜ï¼š

```bash
# æ·»åŠ åˆ° crontab
0 2 * * * cd /www/wwwroot/aibcbot.top/backend && npm run crown:build-map
```

### 2. ç›‘æ§åŒ¹é…ç‡

åœ¨æ˜ å°„è„šæœ¬è¾“å‡ºä¸­æŸ¥çœ‹åŒ¹é…ç‡ï¼š

```
âœ… åŒ¹é…å®Œæˆ: 45/50 åœº (90%)
```

å¦‚æœåŒ¹é…ç‡ä½äº 80%ï¼Œéœ€è¦æ£€æŸ¥ï¼š
- è¯­è¨€åŒ…æ˜¯å¦æœ€æ–°
- çš‡å† èµ›äº‹åç§°æ˜¯å¦è§„èŒƒ
- ç›¸ä¼¼åº¦é˜ˆå€¼æ˜¯å¦åˆç†

### 3. æ‰‹åŠ¨è°ƒæ•´æ˜ å°„

å¯¹äºæ— æ³•è‡ªåŠ¨åŒ¹é…çš„èµ›äº‹ï¼Œå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘ `crown-match-map.json`ï¼š

```json
{
  "matches": [
    {
      "isports_match_id": "123456",
      "crown_gid": "3456789",
      "similarity": 1.0,
      "time_diff_minutes": 0,
      "crown": { ... },
      "isports": { ... }
    }
  ]
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [iSportsAPI å®˜æ–¹æ–‡æ¡£](https://www.isportsapi.com/docs.html?lang=en&id=256)
- [çš‡å† èµ›äº‹æ˜ å°„æ–‡æ¡£](./crown-match-mapping.md)
- [éƒ¨ç½²æŒ‡å—](./isports-api-deployment.md)

