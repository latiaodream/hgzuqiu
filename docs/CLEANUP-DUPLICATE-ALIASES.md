# æ¸…ç†é‡å¤çš„åç§°æ˜ å°„æ•°æ®

## é—®é¢˜æè¿°

åœ¨ `/aliases` åç§°æ˜ å°„ç®¡ç†ä¸­ï¼Œå‘ç°æœ‰å¤šæ¡è®°å½•çš„ `name_en`ï¼ˆè‹±æ–‡åï¼‰ç›¸åŒï¼Œå¯¼è‡´æ•°æ®é‡å¤ã€‚

**åº•å±‚åˆ¤æ–­é€»è¾‘**ï¼šç³»ç»Ÿé€šè¿‡è‹±æ–‡åå­—ï¼ˆ`name_en`ï¼‰æ¥åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€ä¸ªè”èµ›/çƒé˜Ÿã€‚

**é—®é¢˜å½±å“**ï¼š
- æ•°æ®åº“ä¸­å­˜åœ¨é‡å¤è®°å½•
- å¯èƒ½å¯¼è‡´åç§°æ˜ å°„æ··ä¹±
- æµªè´¹å­˜å‚¨ç©ºé—´

## æ¸…ç†è§„åˆ™

å¯¹äº `name_en` ç›¸åŒçš„å¤šæ¡è®°å½•ï¼š

1. **ä¼˜å…ˆä¿ç•™æœ‰ `name_zh_cn`ï¼ˆç®€ä½“ä¸­æ–‡ï¼‰çš„è®°å½•**
2. **åˆ é™¤æ²¡æœ‰ `name_zh_cn` çš„è®°å½•**
3. **å¦‚æœéƒ½æœ‰æˆ–éƒ½æ²¡æœ‰ `name_zh_cn`ï¼Œä¿ç•™ `id` æœ€å°çš„ï¼ˆæœ€æ—©åˆ›å»ºçš„ï¼‰**

## ä½¿ç”¨æ–¹æ³•

### 1. é¢„è§ˆæ¨¡å¼ï¼ˆæ¨èå…ˆè¿è¡Œï¼‰

é¢„è§ˆå°†è¦åˆ é™¤çš„è®°å½•ï¼Œ**ä¸ä¼šå®é™…åˆ é™¤æ•°æ®**ï¼š

```bash
cd /www/wwwroot/aibcbot.top/backend
npm run cleanup:aliases
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
================================================================================
ğŸ§¹ æ¸…ç†é‡å¤çš„åç§°æ˜ å°„æ•°æ®
================================================================================

æ¨¡å¼: ğŸ” é¢„è§ˆæ¨¡å¼ï¼ˆä¸ä¼šåˆ é™¤æ•°æ®ï¼‰

================================================================================
ğŸ” æ£€æŸ¥è¡¨: league_aliases
================================================================================

âš ï¸  å‘ç° 3 ç»„é‡å¤æ•°æ®

ğŸ“‹ è‹±æ–‡å: "Premier League"
   é‡å¤æ•°é‡: 2
   è®°å½•è¯¦æƒ…:
   âœ… ä¿ç•™: ID=123 (æœ‰ç®€ä½“ä¸­æ–‡: "è‹±æ ¼å…°è¶…çº§è”èµ›")
   âŒ åˆ é™¤: ID=456 (ç®€ä½“ä¸­æ–‡: æ— )

ğŸ“‹ è‹±æ–‡å: "La Liga"
   é‡å¤æ•°é‡: 2
   è®°å½•è¯¦æƒ…:
   âœ… ä¿ç•™: ID=234 (æœ‰ç®€ä½“ä¸­æ–‡: "è¥¿ç­ç‰™ç”²çº§è”èµ›")
   âŒ åˆ é™¤: ID=567 (ç®€ä½“ä¸­æ–‡: æ— )

================================================================================
ğŸ“Š ç»Ÿè®¡:
   - é‡å¤ç»„æ•°: 3
   - å¾…åˆ é™¤è®°å½•æ•°: 5
================================================================================

ğŸ” è¿™æ˜¯é¢„è§ˆæ¨¡å¼ï¼Œä¸ä¼šå®é™…åˆ é™¤æ•°æ®
   å¦‚éœ€å®é™…åˆ é™¤ï¼Œè¯·è¿è¡Œ: npm run cleanup:aliases:execute
```

### 2. æ‰§è¡Œæ¨¡å¼ï¼ˆå®é™…åˆ é™¤ï¼‰

**âš ï¸ è­¦å‘Šï¼šæ­¤æ“ä½œä¼šå®é™…åˆ é™¤æ•°æ®ï¼Œè¯·å…ˆè¿è¡Œé¢„è§ˆæ¨¡å¼ç¡®è®¤ï¼**

```bash
cd /www/wwwroot/aibcbot.top/backend
npm run cleanup:aliases:execute
```

æ‰§è¡Œæ—¶ä¼šè¦æ±‚ç¡®è®¤ï¼š

```
âš ï¸  å‡†å¤‡åˆ é™¤ 5 æ¡è®°å½•...
   å¾…åˆ é™¤çš„ ID: 456, 567, 678, 789, 890

â“ ç¡®è®¤åˆ é™¤è¿™äº›è®°å½•å—ï¼Ÿ(yes/no): 
```

è¾“å…¥ `yes` ç¡®è®¤åˆ é™¤ï¼Œè¾“å…¥ `no` å–æ¶ˆæ“ä½œã€‚

**æˆåŠŸè¾“å‡º**ï¼š

```
âœ… åˆ é™¤å®Œæˆï¼
   å®é™…åˆ é™¤è®°å½•æ•°: 5
```

## é˜²æ­¢æœªæ¥é‡å¤

å·²ä¿®æ”¹æ’å…¥é€»è¾‘ï¼Œé˜²æ­¢æœªæ¥å†æ¬¡æ’å…¥é‡å¤æ•°æ®ï¼š

### ä¿®æ”¹å†…å®¹

**æ–‡ä»¶**ï¼š`backend/src/routes/aliases.ts`

**ä¿®æ”¹å‰**ï¼š
```typescript
// åªæ£€æŸ¥ isports_league_id
const existing = await pool.query(
  'SELECT id, name_zh_tw, name_en FROM league_aliases WHERE isports_league_id = $1',
  [league.id]
);
```

**ä¿®æ”¹å**ï¼š
```typescript
// åŒæ—¶æ£€æŸ¥ isports_league_id å’Œ name_en
const existing = await pool.query(
  'SELECT id, name_zh_tw, name_en, name_zh_cn FROM league_aliases WHERE isports_league_id = $1 OR name_en = $2',
  [league.id, league.name]
);

// å¦‚æœå‘ç°å¤šæ¡è®°å½•ï¼Œè·³è¿‡æ’å…¥
if (existing.rows.length > 1) {
  console.log(`âš ï¸  è·³è¿‡è”èµ›: ${league.name} (å‘ç° ${existing.rows.length} æ¡é‡å¤è®°å½•ï¼Œè¯·å…ˆè¿è¡Œæ¸…ç†è„šæœ¬)`);
}
```

### æ•ˆæœ

- âœ… å¦‚æœè‹±æ–‡åå·²å­˜åœ¨ï¼Œä¸ä¼šæ’å…¥æ–°è®°å½•
- âœ… å¦‚æœå‘ç°å¤šæ¡é‡å¤è®°å½•ï¼Œä¼šæç¤ºå…ˆè¿è¡Œæ¸…ç†è„šæœ¬
- âœ… é¿å…æœªæ¥å†æ¬¡äº§ç”Ÿé‡å¤æ•°æ®

## æ•°æ®åº“ç»“æ„

### league_aliases è¡¨

```sql
CREATE TABLE league_aliases (
    id SERIAL PRIMARY KEY,
    canonical_key VARCHAR(120) NOT NULL UNIQUE,
    name_en VARCHAR(200),           -- è‹±æ–‡åï¼ˆç”¨äºåˆ¤æ–­é‡å¤ï¼‰
    name_zh_cn VARCHAR(200),        -- ç®€ä½“ä¸­æ–‡ï¼ˆä¼˜å…ˆä¿ç•™ï¼‰
    name_zh_tw VARCHAR(200),        -- ç¹ä½“ä¸­æ–‡
    name_crown_zh_cn VARCHAR(200),  -- çš‡å† ç®€ä½“ä¸­æ–‡
    aliases JSONB DEFAULT '[]',
    isports_league_id INTEGER,      -- iSports è”èµ› ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### team_aliases è¡¨

```sql
CREATE TABLE team_aliases (
    id SERIAL PRIMARY KEY,
    canonical_key VARCHAR(120) NOT NULL UNIQUE,
    name_en VARCHAR(200),           -- è‹±æ–‡åï¼ˆç”¨äºåˆ¤æ–­é‡å¤ï¼‰
    name_zh_cn VARCHAR(200),        -- ç®€ä½“ä¸­æ–‡ï¼ˆä¼˜å…ˆä¿ç•™ï¼‰
    name_zh_tw VARCHAR(200),        -- ç¹ä½“ä¸­æ–‡
    name_crown_zh_cn VARCHAR(200),  -- çš‡å† ç®€ä½“ä¸­æ–‡
    aliases JSONB DEFAULT '[]',
    isports_team_id INTEGER,        -- iSports çƒé˜Ÿ ID
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦ä¿ç•™æœ‰ `name_zh_cn` çš„è®°å½•ï¼Ÿ

**A**: å› ä¸ºç®€ä½“ä¸­æ–‡æ˜¯å‰ç«¯æ˜¾ç¤ºçš„ä¸»è¦è¯­è¨€ï¼Œæœ‰ç®€ä½“ä¸­æ–‡çš„è®°å½•æ›´æœ‰ä»·å€¼ã€‚

### Q2: å¦‚æœä¸¤æ¡è®°å½•éƒ½æœ‰ `name_zh_cn`ï¼Œä¼šåˆ é™¤å“ªä¸€æ¡ï¼Ÿ

**A**: ä¿ç•™ `id` æœ€å°çš„ï¼ˆæœ€æ—©åˆ›å»ºçš„ï¼‰ï¼Œåˆ é™¤ `id` è¾ƒå¤§çš„ã€‚

### Q3: æ¸…ç†åä¼šå½±å“ç°æœ‰åŠŸèƒ½å—ï¼Ÿ

**A**: ä¸ä¼šã€‚æ¸…ç†åªæ˜¯åˆ é™¤é‡å¤è®°å½•ï¼Œä¿ç•™çš„è®°å½•åŒ…å«æ‰€æœ‰å¿…è¦ä¿¡æ¯ã€‚

### Q4: å¯ä»¥æ¢å¤è¢«åˆ é™¤çš„æ•°æ®å—ï¼Ÿ

**A**: å»ºè®®åœ¨æ‰§è¡Œåˆ é™¤å‰å…ˆå¤‡ä»½æ•°æ®åº“ï¼š

```bash
# å¤‡ä»½æ•°æ®åº“
pg_dump -U postgres -d bclogin > backup_$(date +%Y%m%d_%H%M%S).sql

# æ¢å¤æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
psql -U postgres -d bclogin < backup_20250109_120000.sql
```

### Q5: å¦‚ä½•æŸ¥çœ‹å½“å‰æœ‰å¤šå°‘é‡å¤æ•°æ®ï¼Ÿ

**A**: è¿è¡Œé¢„è§ˆæ¨¡å¼å³å¯æŸ¥çœ‹ï¼š

```bash
npm run cleanup:aliases
```

æˆ–è€…ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼š

```sql
-- æŸ¥çœ‹è”èµ›é‡å¤æ•°æ®
SELECT name_en, COUNT(*) as count
FROM league_aliases
WHERE name_en IS NOT NULL AND name_en != ''
GROUP BY name_en
HAVING COUNT(*) > 1
ORDER BY COUNT(*) DESC;

-- æŸ¥çœ‹çƒé˜Ÿé‡å¤æ•°æ®
SELECT name_en, COUNT(*) as count
FROM team_aliases
WHERE name_en IS NOT NULL AND name_en != ''
GROUP BY name_en
HAVING COUNT(*) > 1
ORDER BY COUNT(*) DESC;
```

## ç›¸å…³æ–‡ä»¶

- **æ¸…ç†è„šæœ¬**: `backend/scripts/cleanup-duplicate-aliases.ts`
- **æ’å…¥é€»è¾‘**: `backend/src/routes/aliases.ts`
- **åç§°æœåŠ¡**: `backend/src/services/name-alias-service.ts`
- **æ•°æ®åº“ç»“æ„**: `database/schema.sql`

## æ‰§è¡Œè®°å½•

### 2025-01-XX - é¦–æ¬¡æ¸…ç†

- **æ‰§è¡Œäºº**: [ä½ çš„åå­—]
- **æ¸…ç†å‰è®°å½•æ•°**: 
  - è”èµ›: XXX æ¡
  - çƒé˜Ÿ: XXX æ¡
- **åˆ é™¤è®°å½•æ•°**:
  - è”èµ›: XXX æ¡
  - çƒé˜Ÿ: XXX æ¡
- **æ¸…ç†åè®°å½•æ•°**:
  - è”èµ›: XXX æ¡
  - çƒé˜Ÿ: XXX æ¡
- **å¤‡æ³¨**: [ä»»ä½•éœ€è¦è®°å½•çš„ä¿¡æ¯]

