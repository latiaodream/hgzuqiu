# 名称映射导入使用说明

## 功能概述

在后台管理系统的「名称映射管理」页面，可以通过上传 Excel 文件批量导入联赛和球队的简体中文翻译。

## 使用步骤

### 方式一：导出未翻译记录（推荐）

1. 进入「名称映射管理」页面
2. 选择「联赛映射」或「球队映射」标签
3. 点击「导出未翻译」按钮
4. 系统会导出所有 `name_zh_cn` 为空的记录
5. 在 Excel 中填写第二列的简体中文翻译
6. 点击「导入翻译」上传填写好的文件

**优点：**
- ✅ 只导出需要翻译的记录，避免重复工作
- ✅ 自动过滤已翻译的记录
- ✅ 文件更小，翻译更快

### 方式二：下载样本文件

1. 进入「名称映射管理」页面
2. 选择「联赛映射」或「球队映射」标签
3. 点击「下载样本」按钮
4. 系统会下载一个 CSV 样本文件

**样本文件位置：**
- 联赛样本：`exports/leagues-sample.xlsx`
- 球队样本：`exports/teams-sample.xlsx`

**适用场景：**
- 第一次使用，想了解文件格式
- 需要参考样本格式

### 2. 准备翻译文件

按照样本格式填写翻译：

| 第一列（英文名称） | 第二列（简体中文翻译） |
|-------------------|---------------------|
| Manchester United | 曼联                |
| Real Madrid       | 皇家马德里           |
| AC Milan          | AC米兰              |

**重要说明：**
- ✅ **不需要表头**，直接从第一行开始填写数据
- ✅ 第一列：英文名称（必须与数据库中的 `name_en` 字段匹配）
- ✅ 第二列：简体中文翻译（将写入 `name_zh_cn` 字段）
- ✅ 支持 `.xlsx` 和 `.xls` 格式
- ✅ 文件大小限制 10MB

### 3. 上传文件

1. 点击「导入翻译」按钮
2. 选择准备好的 Excel 文件
3. 等待上传和处理完成
4. 查看导入结果统计

### 4. 查看导入结果

导入完成后会显示详细统计：
- **总行数**：Excel 文件中的总记录数
- **更新成功**：成功匹配并更新的记录数
- **跳过**：格式不正确或数据为空的记录数
- **未找到**：无法在数据库中找到匹配的记录数

## 匹配策略

系统使用 4 层匹配策略，确保最大化匹配成功率：

### 策略 1：精确匹配 name_en
- 忽略大小写
- 忽略前后空格
- 示例：`"Manchester United"` 精确匹配 `"manchester united"`

### 策略 2：通过 canonical_key 匹配
- 将英文名称标准化为 canonical_key
- 示例：`"Manchester United"` → `"team:manchester united"`

### 策略 3：模糊匹配
- 去除所有特殊字符和空格
- 只保留字母和数字
- 示例：`"Man. United"` 匹配 `"Man United"`

### 策略 4：相似度匹配
- 使用 Levenshtein 距离算法
- 联赛阈值：0.8（80% 相似度）
- 球队阈值：0.85（85% 相似度）
- 示例：`"Manchester Utd"` 匹配 `"Manchester United"`

## 常见问题

### Q1: 为什么有些记录显示「未找到」？

**原因：**
- 英文名称与数据库中的 `name_en` 不完全匹配
- 数据库中没有该联赛/球队的记录

**解决方法：**
1. 先运行 `npm run aliases:import-isports` 导入 iSports 数据
2. 检查英文名称拼写是否正确
3. 使用「名称映射管理」页面手动添加记录

### Q2: 如何查看数据库中的英文名称？

**方法 1：通过后台页面**
- 进入「名称映射管理」页面
- 使用搜索功能查找
- 查看 `iSports 英文` 列

**方法 2：导出现有数据**
```bash
cd /www/wwwroot/aibcbot.top/backend
npm run aliases:export-en
```
会生成 `exports/leagues-en.xlsx` 和 `exports/teams-en.xlsx`

### Q3: 导入后如何验证？

1. 刷新「名称映射管理」页面
2. 查看 `iSports 简体` 列是否已更新
3. 使用筛选器「仅显示未匹配皇冠简体」查看未匹配的记录

### Q4: 可以重复导入吗？

✅ **可以！** 系统会覆盖已有的翻译，不会重复创建记录。

### Q5: 导入的数据会影响皇冠匹配吗？

✅ **会！** 导入的简体中文翻译会用于：
1. 皇冠赛事数据匹配（优先使用 `name_zh_cn` 匹配）
2. 前端显示（显示简体中文名称）
3. 提高整体匹配率

## 命令行工具

### 生成样本文件
```bash
cd /www/wwwroot/aibcbot.top/backend
npm run aliases:generate-sample
```

### 导入 iSports 数据
```bash
npm run aliases:import-isports
```

### 导出英文名称
```bash
npm run aliases:export-en
```

### 命令行导入翻译
```bash
npx tsx scripts/import-translated-xlsx.ts ../exports/leagues-en.xlsx
npx tsx scripts/import-translated-xlsx.ts ../exports/teams-en.xlsx
```

## API 接口

### 导入联赛翻译
```bash
POST /api/aliases/leagues/import
Content-Type: multipart/form-data

file: <Excel 文件>
```

### 导入球队翻译
```bash
POST /api/aliases/teams/import
Content-Type: multipart/form-data

file: <Excel 文件>
```

### 导出未翻译的联赛
```bash
GET /api/aliases/leagues/export-untranslated
Authorization: Bearer <token>

响应：Excel 文件（application/vnd.openxmlformats-officedocument.spreadsheetml.sheet）
```

### 导出未翻译的球队
```bash
GET /api/aliases/teams/export-untranslated
Authorization: Bearer <token>

响应：Excel 文件（application/vnd.openxmlformats-officedocument.spreadsheetml.sheet）
```

### 导入响应格式
```json
{
  "success": true,
  "data": {
    "type": "league",
    "total": 128,
    "updated": 109,
    "skipped": 0,
    "notFound": 19
  },
  "message": "导入完成：更新 109 个，跳过 0 个，未找到 19 个"
}
```

### 导出错误响应（无未翻译记录）
```json
{
  "success": false,
  "error": "没有未翻译的联赛"
}
```

## 最佳实践

### 推荐工作流程

1. **先导入 iSports 数据**
   ```bash
   npm run aliases:import-isports
   ```

2. **导出未翻译的记录**
   - 在后台页面点击「导出未翻译」
   - 或使用命令行：`npm run aliases:export-en`

3. **翻译并导入**
   - 在 Excel 中填写第二列的简体中文翻译
   - 在后台页面点击「导入翻译」上传文件
   - 或使用命令行工具

4. **验证匹配率**
   - 查看页面底部的匹配率统计
   - 目标：联赛 85%+，球队 90%+

5. **重复步骤 2-4**
   - 如果还有未翻译的记录，重复导出-翻译-导入流程
   - 直到所有记录都已翻译

6. **运行皇冠匹配**
   ```bash
   CROWN_USERNAME=xxx CROWN_PASSWORD=xxx npm run aliases:import-crown
   ```

### 提高效率的技巧

1. **批量翻译**
   - 导出未翻译记录后，使用翻译工具批量翻译
   - 推荐使用 Google Translate API 或 DeepL API

2. **分批处理**
   - 如果记录太多，可以分批翻译和导入
   - 每次导入后系统会自动过滤已翻译的记录

3. **使用筛选器**
   - 使用「仅显示未匹配皇冠简体」筛选器
   - 优先翻译未匹配的记录，提高皇冠匹配率

4. **定期更新**
   - 定期运行 `npm run aliases:import-isports` 获取新数据
   - 导出并翻译新增的记录

## 技术细节

### 文件处理流程
1. 前端上传文件到 `/api/aliases/leagues/import` 或 `/api/aliases/teams/import`
2. 后端使用 `multer` 接收文件并保存到临时目录
3. 使用 `xlsx` 库解析 Excel 文件
4. 遍历每一行，使用 4 层匹配策略查找对应记录
5. 更新 `name_zh_cn` 字段
6. 返回统计结果
7. 自动删除临时文件

### 数据库字段说明
- `name_en`：iSports 英文名称（来自 iSports API）
- `name_zh_tw`：iSports 繁体中文（来自 iSports 语言包）
- `name_zh_cn`：iSports 简体中文（**从翻译文件导入**）
- `name_crown_zh_cn`：皇冠简体中文（来自皇冠官方 API）

### 匹配优先级
皇冠赛事匹配时的优先级：
1. 精确匹配 `name_zh_cn`（iSports 简体）
2. 精确匹配 `name_crown_zh_cn`（皇冠简体）
3. 别名匹配
4. 模糊匹配（优先比较 `name_zh_cn`）

## 更新日志

### 2025-01-06 v2
- ✅ 添加「导出未翻译」功能
- ✅ 自动过滤已翻译的记录
- ✅ 优化工作流程（导出-翻译-导入）
- ✅ 更新使用说明文档

### 2025-01-06 v1
- ✅ 添加后台文件上传功能
- ✅ 添加「下载样本」按钮
- ✅ 添加「导入翻译」按钮
- ✅ 创建样本 Excel 文件
- ✅ 优化匹配策略（4 层匹配）
- ✅ 修复更新时覆盖其他字段的问题
- ✅ 修正导入目标字段（name_zh_cn）

