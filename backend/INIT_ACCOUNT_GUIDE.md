# 皇冠账号初始化指南

## 问题说明

当新创建的皇冠账号首次登录时，系统会强制要求：
1. 修改登录账号（Login ID）
2. 修改登录密码

这个过程必须完成后才能正常使用账号。

## 常见错误

### ❌ 错误1: 新密码与旧密码相同

**错误信息**: `您的新密码必须和现用密码不一样。`

**原因**: 在初始化时，新密码参数与账号当前密码相同

**解决方法**: 使用不同的新密码

```bash
# ❌ 错误示例 - 新密码和旧密码都是 aa112233
node backend/run-init.js 19 User2024ab aa112233

# ✅ 正确示例 - 使用不同的新密码
node backend/run-init.js 19 User2024ab Pass2024XY
```

### ❌ 错误2: 密码格式不符合要求

**错误信息**: `Your password must be between 6 to 12 alphanumeric (A-Z & 0-9) characters.`

**原因**: 密码不符合皇冠系统要求

**密码要求**:
- 长度: 6-12位
- 字符: 只能包含字母(A-Z, a-z)和数字(0-9)
- 组成: 至少2个字母 + 至少1个数字
- 不能包含空格或特殊字符

**示例**:
```bash
# ✅ 合格的密码
Pass2024      # 4个字母 + 4个数字
User123       # 4个字母 + 3个数字
Abc12345      # 3个字母 + 5个数字

# ❌ 不合格的密码
12345678      # 只有数字，没有字母
abcdefgh      # 只有字母，没有数字
Pass@2024     # 包含特殊字符 @
Pass 2024     # 包含空格
```

### ❌ 错误3: 用户名格式不符合要求

**用户名要求**:
- 长度: 6-12位
- 字符: 只能包含字母(A-Z, a-z)和数字(0-9)
- 组成: 至少2个字母 + 至少1个数字
- 不能包含空格或特殊字符

**示例**:
```bash
# ✅ 合格的用户名
User2024      # 4个字母 + 4个数字
Player123     # 6个字母 + 3个数字
Abc12345      # 3个字母 + 5个数字

# ❌ 不合格的用户名
12345678      # 只有数字
username      # 只有字母
User@2024     # 包含特殊字符
```

## 正确使用方法

### 1. 准备工作

确保你知道：
- 账号ID（在数据库中的ID）
- 账号当前密码
- 想要设置的新用户名
- 想要设置的新密码（必须与当前密码不同）

### 2. 执行初始化

```bash
# 基本语法
node backend/run-init.js <账号ID> <新用户名> <新密码>

# 实际示例
node backend/run-init.js 19 User2024ab Pass2024XY
```

### 3. 查看执行结果

**成功示例**:
```
Running: node backend/run-init.js 19 User2024ab Pass2024XY

📋 账号信息:
   ID: 19
   当前用户名: b8wMGtVkUf
   当前密码: ********
   新用户名: User2024ab
   新密码: **********

🚀 开始初始化账号...

✅ 账号初始化成功！
   新用户名: User2024ab
   新密码: **********
✅ 数据库已更新
```

**失败示例**:
```
Running: node backend/run-init.js 19 User2024ab aa112233

📋 账号信息:
   ID: 19
   当前用户名: b8wMGtVkUf
   当前密码: ********
   新用户名: User2024ab
   新密码: ********

❌ 新密码不能与当前密码相同！
请使用不同的密码，例如:
   node backend/run-init.js 19 User2024ab NewPass2024
```

## 初始化流程说明

系统会自动执行以下步骤：

1. **登录账号** - 使用当前用户名和密码登录
2. **处理四位安全码** - 自动拒绝或设置四位安全码
3. **检测改密页面** - 等待皇冠系统显示修改账号/密码页面
4. **修改登录账号** - 填写并提交新的登录账号（如果需要）
5. **修改登录密码** - 填写并提交新的登录密码
6. **验证登录** - 使用新凭证重新登录验证
7. **更新数据库** - 将新凭证保存到数据库

## 故障排查

### 问题: 卡在修改密码步骤

**可能原因**:
1. 新密码与旧密码相同
2. 密码格式不符合要求
3. 页面元素未正确加载

**解决方法**:
1. 检查新密码是否与旧密码不同
2. 确认密码符合格式要求（6-12位，至少2字母+1数字）
3. 查看日志文件中的详细错误信息

### 问题: 提示"未检测到改密页面"

**可能原因**:
1. 账号已经初始化过
2. 网络连接问题
3. 皇冠网站结构变化

**解决方法**:
1. 尝试手动登录确认是否需要改密
2. 检查网络连接
3. 查看截图文件了解页面状态

### 问题: 登录失败

**可能原因**:
1. 账号密码错误
2. 账号被锁定
3. 网络问题

**解决方法**:
1. 确认数据库中的密码正确
2. 联系上级解锁账号
3. 检查网络连接

## 查看日志和截图

初始化过程中会生成日志和截图文件：

```bash
# 查看最新的日志文件
ls -lt backend/*.log | head -5

# 查看截图文件
ls -lt backend/passcodeCtx-*.png | head -10

# 查看HTML快照
ls -lt backend/*.html | head -5
```

这些文件可以帮助你诊断问题。

## 手动测试

如果自动化失败，可以使用测试脚本手动观察过程：

```bash
# 测试密码修改流程（已创建的账号）
node backend/test-password-change.js

# 测试完整初始化流程（新账号）
node backend/test-initialize.js
```

这些脚本会以非无头模式运行浏览器，你可以看到整个过程。

## 技术细节

### 密码修改表单选择器

系统会尝试以下选择器来定位密码输入框：

- `#password` - 新密码输入框
- `#REpassword` - 确认密码输入框
- `#oldpassword` - 旧密码输入框（如果需要）

### 提交按钮选择器

系统会尝试以下选择器来定位提交按钮：

- `#greenBtn:visible`
- `.btn_submit:has-text("提交")`
- `.btn_submit:has-text("确认")`
- `button:has-text("提交")`

### 错误检测

系统会检测以下错误提示：

- `#chgpwd_text_error:visible` - 密码修改错误提示
- `.text_error:visible` - 通用错误提示

## 常见错误信息对照

| 中文错误信息 | 英文错误信息 | 原因 | 解决方法 |
|------------|------------|------|---------|
| 您的新密码必须和现用密码不一样 | Your new password must be different from your current password | 新旧密码相同 | 使用不同的新密码 |
| 密码必须为6-12位字母数字组合 | Your password must be between 6 to 12 alphanumeric characters | 密码格式错误 | 使用符合要求的密码 |
| 密码过于简单 | A simple Password may cause security problems | 密码强度不够 | 使用更复杂的密码组合 |

## 联系支持

如果遇到无法解决的问题，请提供：
1. 完整的错误日志
2. 相关的截图文件
3. 账号ID和当前状态
4. 执行的命令

